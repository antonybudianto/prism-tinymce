/**
 * Prism plugin by Metrakit
 * contact@jordane.net
*/
tinymce.PluginManager.add('prism', function(editor, url) {
    
    var languageList = [
        'Markup',
        'CSS',
        'Javascript',
        'PHP',
        'PHP-Extras',
        'Perl',
        'CoffeeScript',
        'Sass',
        'Scala',
        'SQL',
        'Swift',
        'Bash',
        'HTTP',
        'Ruby',
        'Java',
        'Ini',
        'Apache',
        'Git',
        'Less',
        'Markdown',
        'ASPNet',
        'CSharp',
        'CPP',
        'Fortran',
        'Pascal',
        'Go',
        'Python',
        'R',
        'Ruby',
        'YAML',
        'ObjectiveC'
    ];

    var menuLanguages = [];
    tinymce.each(languageList, function(language) {
        menuLanguages.push({
            text: language,
            value: language.toLowerCase()
        });
    });
	
    editor.addButton('prism', {
        icon: "code",
        title: "Add code snippet",
        onclick: function() {
            var selected = tinyMCE.activeEditor.selection.getContent({format : 'text'})
			var code = editor.selection.getNode()
			if(selected == '' && code.tagName == 'CODE'){
				var lang = code.parentNode.className.replace('language-','')
				selected = editor.selection.getStart().textContent
			}
            editor.windowManager.open({
                title: 'Insert your code',
                width: 600,
                height: 400,
				maximizable: true,
				resizable: true,
                body: [
                    {
                        type: 'TextBox', 
                        name: 'code', 
                        label: 'Code :',
                        multiline: true,
                        minHeight: 300,
                        value: selected
                    },
                    {
                        type: 'listbox',
                        name: 'language',
                        label: 'Language :',
                        'values': menuLanguages
					},
                ],
                onsubmit: function(e) {
                    var finalCode = e.data.code

                    // Fixes tags stripped by converting it to HTML entities
                    if(e.data.language == 'markup') finalCode = finalCode.replace(/\</g," &lt;")
	
                    editor.insertContent('<pre class="language-' + e.data.language + '"><code>' + finalCode + '</code></pre>');
                }
            });
        }
    });

});
